# —Ñ–∞–π–ª docker-build.yml (—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã)
name: Build and Push Docker Images

on:
    push:
        tags:
            - 'hw-monitor-v*'
            - 'hw-monitor-licd-v*'
            - 'hw-monitor-nginx-combined-v*'
    workflow_dispatch:
        inputs:
            service:
                description: '–°–µ—Ä–≤–∏—Å –¥–ª—è —Å–±–æ—Ä–∫–∏'
                required: true
                type: choice
                options:
                    - hw-monitor
                    - hw-monitor-licd
                    - hw-monitor-nginx-combined
            version:
                description: '–í–µ—Ä—Å–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.0.0-alpha.8)'
                required: true
                type: string

jobs:
    code-quality:
        # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ release, PR, workflow_run, –≤—Ä—É—á–Ω—É—é –∏ –Ω–∞ push (—Ç–µ–≥–∏)
        if: >
            github.event_name == 'release' ||
            github.event_name == 'pull_request' ||
            (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
            github.event_name == 'workflow_dispatch' ||
            github.event_name == 'push'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  # –ü—Ä–∏ workflow_run –Ω—É–∂–Ω–æ —á–µ–∫–∞—É—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –≤–µ—Ç–∫—É
                  ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Check code formatting
              run: |
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
                  if ! yarn prettier --check .; then
                    echo "‚ùå –û–®–ò–ë–ö–ê: –ö–æ–¥ –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!"
                    echo "üìù –î–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ:"
                    echo "   yarn format"
                    echo "   git add ."
                    echo "   git commit -m 'fix: format code'"
                    echo "   git push"
                    exit 1
                  else
                    echo "‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
                  fi

            - name: Type checking
              run: |
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã TypeScript..."
                  yarn tsc --noEmit

            - name: Linting
              run: |
                  echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–æ–º..."
                  yarn lint

    build-and-push:
        runs-on: ubuntu-latest
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        needs: code-quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to DockerHub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Determine service, version and tags
              id: vars
              shell: bash
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    SERVICE="${{ github.event.inputs.service }}"
                    VERSION="${{ github.event.inputs.version }}"
                    TAG="${SERVICE}-v${VERSION}"
                  else
                    TAG="${GITHUB_REF_NAME}" # –Ω–∞–ø—Ä–∏–º–µ—Ä: hw-monitor-v1.0.0-alpha
                    SERVICE="${TAG%%-v*}"    # hw-monitor | hw-monitor-licd | hw-monitor-nginx-combined
                    VERSION="${TAG#${SERVICE}-v}" # 1.0.0-alpha –∏–ª–∏ 1.0.0
                  fi

                  if [[ -z "$SERVICE" || -z "$VERSION" ]]; then
                    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: service='$SERVICE' version='$VERSION'"
                    exit 1
                  fi

                  ALIAS_TAG="latest"

                  case "$SERVICE" in
                    hw-monitor)
                      IMAGE="deymonster/hw-monitor"
                      DOCKERFILE="./Dockerfile"
                      CONTEXT="."
                      ;;
                    hw-monitor-licd)
                      IMAGE="deymonster/hw-monitor-licd"
                      DOCKERFILE="./licd/Dockerfile"
                      CONTEXT="./licd"
                      ;;
                    hw-monitor-nginx-combined)
                      IMAGE="deymonster/hw-monitor-nginx-combined"
                      DOCKERFILE="./Dockerfile.nginx-combined"
                      CONTEXT="."
                      ;;
                    *)
                      echo "‚ùå Unsupported service: $SERVICE"
                      exit 1
                      ;;
                  esac
                  echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  echo "COMMIT=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
                  echo "DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
                  echo "ALIAS_TAG=$ALIAS_TAG" >> $GITHUB_OUTPUT
                  echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT
                  echo "DOCKERFILE=$DOCKERFILE" >> $GITHUB_OUTPUT
                  echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT

            - name: Build and push selected service
              uses: docker/build-push-action@v4
              with:
                  context: ${{ steps.vars.outputs.CONTEXT }}
                  file: ${{ steps.vars.outputs.DOCKERFILE }}
                  push: true
                  tags: |
                      ${{ steps.vars.outputs.IMAGE }}:${{ steps.vars.outputs.ALIAS_TAG }}
                      ${{ steps.vars.outputs.IMAGE }}:v${{ steps.vars.outputs.VERSION }}
                  build-args: |
                      VERSION=${{ steps.vars.outputs.VERSION }}
                      COMMIT=${{ steps.vars.outputs.COMMIT }}
                      DATE=${{ steps.vars.outputs.DATE }}
                      ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Ensure hw-monitor-nginx-combined:latest points to newest tag
              if: ${{ steps.vars.outputs.SERVICE == 'hw-monitor' }}
              env:
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  REPO="deymonster/hw-monitor-nginx-combined"

                  if ! command -v jq >/dev/null 2>&1; then
                    sudo apt-get update -y
                    sudo apt-get install -y jq
                  fi

                  echo "–ü–æ–ª—É—á–∞–µ–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–π —Ç–µ–≥ –¥–ª—è $REPO..."
                  LATEST_VERSION_TAG="$(curl -s -u "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" "https://hub.docker.com/v2/repositories/${REPO}/tags/?page_size=100" \
                    | jq -r '.results | map(select(.name | test("^v"))) | sort_by(.last_updated) | last | .name')"

                  if [[ -z "$LATEST_VERSION_TAG" || "$LATEST_VERSION_TAG" == "null" ]]; then
                    echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤ –¥–ª—è $REPO ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º."
                    exit 0
                  fi

                  echo "–°–∞–º—ã–π —Å–≤–µ–∂–∏–π —Ç–µ–≥: $LATEST_VERSION_TAG"

                  set +e
                  CURRENT_DIGEST="$(docker buildx imagetools inspect -j "${REPO}:latest" 2>/dev/null | jq -r '.manifest.digest' || true)"
                  set -e
                  NEW_DIGEST="$(docker buildx imagetools inspect -j "${REPO}:${LATEST_VERSION_TAG}" | jq -r '.manifest.digest')"

                  if [[ -n "$CURRENT_DIGEST" && "$CURRENT_DIGEST" == "$NEW_DIGEST" ]]; then
                    echo "latest —É–∂–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ ${LATEST_VERSION_TAG} (digest ${NEW_DIGEST})"
                  else
                    echo "–û–±–Ω–æ–≤–ª—è—é latest ‚Üí ${LATEST_VERSION_TAG} (digest ${NEW_DIGEST})"
                    docker buildx imagetools create -t "${REPO}:latest" "${REPO}:${LATEST_VERSION_TAG}"
                    echo "–ì–æ—Ç–æ–≤–æ."
                  fi

            - name: Ensure hw-monitor-licd:latest points to newest tag
              if: ${{ steps.vars.outputs.SERVICE == 'hw-monitor' }}
              env:
                  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
                  DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
              run: |
                  set -euo pipefail
                  REPO="deymonster/hw-monitor-licd"

                  if ! command -v jq >/dev/null 2>&1; then
                    sudo apt-get update -y
                    sudo apt-get install -y jq
                  fi

                  echo "–ü–æ–ª—É—á–∞–µ–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–π —Ç–µ–≥ –¥–ª—è $REPO..."
                  LATEST_VERSION_TAG="$(curl -s -u "${DOCKERHUB_USERNAME}:${DOCKERHUB_TOKEN}" "https://hub.docker.com/v2/repositories/${REPO}/tags/?page_size=100" \
                    | jq -r '.results | map(select(.name | test("^v"))) | sort_by(.last_updated) | last | .name')"

                  if [[ -z "$LATEST_VERSION_TAG" || "$LATEST_VERSION_TAG" == "null" ]]; then
                    echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤ –¥–ª—è $REPO ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º."
                    exit 0
                  fi

                  echo "–°–∞–º—ã–π —Å–≤–µ–∂–∏–π —Ç–µ–≥: $LATEST_VERSION_TAG"

                  set +e
                  CURRENT_DIGEST="$(docker buildx imagetools inspect -j "${REPO}:latest" 2>/dev/null | jq -r '.manifest.digest' || true)"
                  set -e
                  NEW_DIGEST="$(docker buildx imagetools inspect -j "${REPO}:${LATEST_VERSION_TAG}" | jq -r '.manifest.digest')"

                  if [[ -n "$CURRENT_DIGEST" && "$CURRENT_DIGEST" == "$NEW_DIGEST" ]]; then
                    echo "latest —É–∂–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ ${LATEST_VERSION_TAG} (digest ${NEW_DIGEST})"
                  else
                    echo "–û–±–Ω–æ–≤–ª—è—é latest ‚Üí ${LATEST_VERSION_TAG} (digest ${NEW_DIGEST})"
                    docker buildx imagetools create -t "${REPO}:latest" "${REPO}:${LATEST_VERSION_TAG}"
                    echo "–ì–æ—Ç–æ–≤–æ."
                  fi

            - name: Update docker-compose.prod.yml image tags
              if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
              run: |
                  set -euo pipefail
                  SERVICE="${{ steps.vars.outputs.SERVICE }}"
                  VERSION="${{ steps.vars.outputs.VERSION }}"

                  echo "–ü–∞—Ç—á–∏–º docker-compose.prod.yml –¥–ª—è $SERVICE ‚Üí v${VERSION}"

                  case "$SERVICE" in
                    hw-monitor)
                      sed -E -i 's|(image:\s*deymonster/hw-monitor:)[^ #]+|\1v'"$VERSION"'|g' docker-compose.prod.yml
                      ;;
                    hw-monitor-licd)
                      sed -E -i 's|(image:\s*deymonster/hw-monitor-licd:)[^ #]+|\1v'"$VERSION"'|g' docker-compose.prod.yml
                      ;;
                    hw-monitor-nginx-combined)
                      sed -E -i 's|(image:\s*deymonster/hw-monitor-nginx-combined:)[^ #]+|\1v'"$VERSION"'|g' docker-compose.prod.yml
                      ;;
                  esac

                  echo "–ò—Ç–æ–≥–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏:"
                  grep -nE 'image:\s*deymonster/(hw-monitor|hw-monitor-licd|hw-monitor-nginx-combined):' docker-compose.prod.yml || true

            - name: Upload deploy files to Nextcloud
              if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
              env:
                  NEXTCLOUD_PASSWORD: ${{ secrets.NEXTCLOUD }}
              run: |
                  set -euo pipefail
                  echo "–ó–∞–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –≤ Nextcloud..."

                  if [[ -z "${NEXTCLOUD_PASSWORD}" ]]; then
                    echo "‚ùå NEXTCLOUD —Å–µ–∫—Ä–µ—Ç –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –ø—É—Å—Ç (Repository secrets ‚Üí NEXTCLOUD)"
                    exit 1
                  fi

                  BASE="https://storage.deymonster.ru/remote.php/dav/files/admin/hw"
                  AUTH="admin:${NEXTCLOUD_PASSWORD}"

                  test -f docker-compose.prod.yml || { echo "–§–∞–π–ª docker-compose.prod.yml –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"; exit 1; }
                  test -f scripts/install_v2.sh || { echo "–§–∞–π–ª scripts/install_v2.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"; exit 1; }
                  test -f scripts/hwctl.sh || { echo "–§–∞–π–ª scripts/hwctl.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"; exit 1; }
                  test -f scripts/cleanup.sh || { echo "–§–∞–π–ª scripts/cleanup.sh –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"; exit 1; }

                  curl -f -s -u "$AUTH" -X PUT "$BASE/deploys/docker-compose/docker-compose.prod.yml" \
                       --data-binary @docker-compose.prod.yml \
                       -w "docker-compose.prod.yml ‚Üí %{http_code}\n" -o /dev/null

                  curl -f -s -u "$AUTH" -X PUT "$BASE/deploys/scripts/install_v2.sh" \
                       --data-binary @scripts/install_v2.sh \
                       -w "install_v2.sh ‚Üí %{http_code}\n" -o /dev/null

                  curl -f -s -u "$AUTH" -X PUT "$BASE/deploys/scripts/hwctl.sh" \
                       --data-binary @scripts/hwctl.sh \
                       -w "hwctl.sh ‚Üí %{http_code}\n" -o /dev/null

                  curl -f -s -u "$AUTH" -X PUT "$BASE/deploys/scripts/cleanup.sh" \
                       --data-binary @scripts/cleanup.sh \
                       -w "cleanup.sh ‚Üí %{http_code}\n" -o /dev/null

                  echo ""
                  echo "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–∂–Ω–æ –∑–¥–µ—Å—å:"
                  echo "‚Ä¢ https://storage.deymonster.ru/apps/files/?dir=/hw/deploys/docker-compose"
                  echo "‚Ä¢ https://storage.deymonster.ru/apps/files/?dir=/hw/deploys/scripts"
