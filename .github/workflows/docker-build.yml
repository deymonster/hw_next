# Ñ„Ð°Ð¹Ð» docker-build.yml (Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ñ‹)
name: Build and Push Docker Images

on:
    push:
        tags:
            - 'hw-monitor-v*'
            - 'hw-monitor-licd-v*'
            - 'hw-monitor-nginx-combined-v*'
    workflow_dispatch:
        inputs:
            service:
                description: 'Ð¡ÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸'
                required: true
                type: choice
                options:
                    - hw-monitor
                    - hw-monitor-licd
                    - hw-monitor-nginx-combined
            version:
                description: 'Ð’ÐµÑ€ÑÐ¸Ñ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 1.0.0-alpha.8)'
                required: true
                type: string

jobs:
    code-quality:
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð½Ð° release, PR, workflow_run, Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸ Ð½Ð° push (Ñ‚ÐµÐ³Ð¸)
        if: >
            github.event_name == 'release' ||
            github.event_name == 'pull_request' ||
            (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
            github.event_name == 'workflow_dispatch' ||
            github.event_name == 'push'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  # ÐŸÑ€Ð¸ workflow_run Ð½ÑƒÐ¶Ð½Ð¾ Ñ‡ÐµÐºÐ°ÑƒÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
                  ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '20'
                  cache: 'yarn'

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Check code formatting
              run: |
                  echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð°..."
                  if ! yarn prettier --check .; then
                    echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐšÐ¾Ð´ Ð½Ðµ Ð¾Ñ‚Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾!"
                    echo "ðŸ“ Ð”Ð»Ñ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾:"
                    echo "   yarn format"
                    echo "   git add ."
                    echo "   git commit -m 'fix: format code'"
                    echo "   git push"
                    exit 1
                  else
                    echo "âœ… Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾"
                  fi

            - name: Type checking
              run: |
                  echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¸Ð¿Ñ‹ TypeScript..."
                  yarn tsc --noEmit

            - name: Linting
              run: |
                  echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð´ Ð»Ð¸Ð½Ñ‚ÐµÑ€Ð¾Ð¼..."
                  yarn lint

    build-and-push:
        runs-on: ubuntu-latest
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        needs: code-quality
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to DockerHub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Determine service, version and tags
              id: vars
              shell: bash
              run: |
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                    SERVICE="${{ github.event.inputs.service }}"
                    VERSION="${{ github.event.inputs.version }}"
                    TAG="${SERVICE}-v${VERSION}"
                  else
                    TAG="${GITHUB_REF_NAME}" # Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: hw-monitor-v1.0.0-alpha
                    SERVICE="${TAG%%-v*}"    # hw-monitor | hw-monitor-licd | hw-monitor-nginx-combined
                    VERSION="${TAG#${SERVICE}-v}" # 1.0.0-alpha Ð¸Ð»Ð¸ 1.0.0
                  fi

                  if [[ -z "$SERVICE" || -z "$VERSION" ]]; then
                    echo "âŒ ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…: service='$SERVICE' version='$VERSION'"
                    exit 1
                  fi

                  if [[ "$VERSION" == *"-alpha"* ]]; then
                    ALIAS_TAG="alpha"
                  else
                    ALIAS_TAG="latest"
                  fi

                  if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+-alpha$ ]]; then
                    git fetch --tags --force
                    BASE="${SERVICE}-v${VERSION}"
                    LAST=$(git tag -l "${BASE}.*" | sed -E 's/.*-alpha\.([0-9]+)$/\1/' | sort -n | tail -n1)
                    if [[ -z "$LAST" ]]; then
                      NEXT=1
                    else
                      NEXT=$((LAST+1))
                    fi
                    VERSION_TAG="${SERVICE}-v${VERSION}.${NEXT}"
                  else
                    VERSION_TAG="${TAG}"
                  fi

                  case "$SERVICE" in
                    hw-monitor)
                      IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/hw-monitor"
                      DOCKERFILE="./Dockerfile"
                      CONTEXT="."
                      ;;
                    hw-monitor-licd)
                      IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/hw-monitor-licd"
                      DOCKERFILE="./licd/Dockerfile"
                      CONTEXT="./licd"
                      ;;
                    hw-monitor-nginx-combined)
                      IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/hw-monitor-nginx-combined"
                      DOCKERFILE="./Dockerfile.nginx-combined"
                      CONTEXT="."
                      ;;
                    *)
                      echo "âŒ Unsupported service: $SERVICE"
                      exit 1
                      ;;
                  esac

                  echo "SERVICE=$SERVICE" >> $GITHUB_OUTPUT
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                  echo "COMMIT=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
                  echo "DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
                  echo "ALIAS_TAG=$ALIAS_TAG" >> $GITHUB_OUTPUT
                  echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_OUTPUT
                  echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT
                  echo "DOCKERFILE=$DOCKERFILE" >> $GITHUB_OUTPUT
                  echo "CONTEXT=$CONTEXT" >> $GITHUB_OUTPUT

            - name: Build and push selected service
              uses: docker/build-push-action@v4
              with:
                  context: ${{ steps.vars.outputs.CONTEXT }}
                  file: ${{ steps.vars.outputs.DOCKERFILE }}
                  push: true
                  tags: |
                      ${{ steps.vars.outputs.IMAGE }}:${{ steps.vars.outputs.ALIAS_TAG }}
                      ${{ steps.vars.outputs.IMAGE }}:${{ steps.vars.outputs.VERSION_TAG }}
                  build-args: |
                      VERSION=${{ steps.vars.outputs.VERSION }}
                      COMMIT=${{ steps.vars.outputs.COMMIT }}
                      DATE=${{ steps.vars.outputs.DATE }}
                      ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
