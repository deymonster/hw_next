# Система мониторинга оборудования

## Краткое описание программного обеспечения

Система мониторинга оборудования представляет собой комплексное решение для наблюдения за состоянием компьютеров и серверов в локальной сети. Система построена на базе современных технологий, включая Next.js, Prometheus и Go-агенты, и предоставляет удобный веб-интерфейс для мониторинга и управления устройствами.

Основное назначение системы — автоматическое обнаружение устройств в сети, сбор метрик о состоянии оборудования (CPU, RAM, диски, температура и т.д.), оповещение о критических событиях и предоставление аналитической информации в режиме реального времени.

## Функциональные характеристики

### Управление устройствами

- Автоматическое сканирование сети для обнаружения устройств
- Сбор метрик оборудования в реальном времени
- Динамическая конфигурация целей Prometheus
- Мониторинг статуса устройств

### Мониторинг метрик

- Использование и температура CPU
- Использование оперативной памяти
- Емкость и использование дисков
- Метрики GPU
- Информация о BIOS и материнской плате
- Список запущенных процессов

### Система пользователей

- Аутентификация и авторизация пользователей
- Система восстановления пароля
- Уведомления по электронной почте

### Интерфейс

- Современная, адаптивная панель управления
- Поддержка темной/светлой темы
- Многоязычная поддержка (английский/русский)
- Уведомления о событиях

### Система оповещений

- Настраиваемые пороги оповещений
- Несколько каналов уведомлений:
    - Уведомления в Telegram
    - Оповещения по электронной почте
    - Уведомления в панели
- Настраиваемые правила оповещений для различных метрик

## Руководство по развертыванию

### Системные требования

1. Операционная система:

    - Linux (рекомендуется Ubuntu 20.04+)
    - Windows 10/11 с WSL2
    - macOS 12+

2. Минимальные требования к оборудованию:
    - CPU: 2 ядра
    - RAM: 4 ГБ
    - Диск: 20 ГБ свободного места

## Технологический стек

### Фронтенд

- Next.js 14 (App Router)
- TypeScript
- TailwindCSS
- Next-Auth для аутентификации

### Бэкенд

- Next.js API routes
- Prisma ORM
- PostgreSQL база данных
- Redis для кэширования
- Node.js

### Мониторинг

- Prometheus для сбора метрик
- AlertManager для обработки оповещений
- Пользовательские Go-агенты для рабочих станций
- Nginx в качестве обратного прокси

## Предварительные требования

- Docker и Docker Compose

## Настройка окружения

1. Клонировать репозиторий
2. Скопировать `.env.example` в `.env` и настроить:
    - Учетные данные базы данных
    - Настройки Prometheus
    - Конфигурация SMTP
    - Токен бота Telegram
    - Конфигурация Redis

## Руководство по развертыванию

### Системные требования

1. Операционная система:

    - Linux (рекомендуется Ubuntu 20.04+)
    - Windows 10/11
    - macOS 12+

2. Минимальные требования к оборудованию:
    - CPU: 2 ядра
    - RAM: 4 ГБ
    - Диск: 20 ГБ свободного места

## Установка серверной части

### Установка Docker и Docker Compose

#### Для Linux (Ubuntu/Debian):

````bash
# Установка Docker
sudo apt-get update
sudo apt-get install -y docker.io

# Установка Docker Compose
sudo apt-get install -y docker-compose

# Добавление пользователя в группу docker
sudo usermod -aG docker $USER
newgrp docker

# Проверка установки
docker --version
docker-compose --version

#### Для Windows:

1. Установите [Docker Desktop] с официального сайта: (https://www.docker.com/products/docker-desktop) для Windows.
2. Убедитесь, что включен Hyper-V в BIOS.
3. Установите [Docker Compose](https://docs.docker.com/compose/install/) для Windows.
4. После установки убедитесь, что Docker работает, запустив в командной строке:
   ```bash
   docker --version
   docker-compose --version
````

### Настройка и запуск системы

1. Настройка переменных окружения:
    - Скопируйте файл .env.example в .env
    - Отредактируйте .env файл, настроив следующие параметры:
        - `NEXT_PUBLIC_BASE_URL` и `NEXT_PUBLIC_SERVER_IP`: укажите IP-адрес вашего сервера
        - `POSTGRES_PASSWORD`: установите надежный пароль для базы данных
        - `TELEGRAM_BOT_TOKEN`: токен вашего Telegram бота (получите у @BotFather)
        - `TELEGRAM_CHAT_ID` и `ADMIN_TELEGRAM_CHAT_ID`: ID чата для получения уведомлений
        - `ADMIN_USERNAME`, `ADMIN_PASSWORD` и `ADMIN_EMAIL`: учетные данные администратора
        - `HANDSHAKE_KEY`: секретный ключ для агентов (придумайте сложный)
        - `PROMETHEUS_AUTH_PASSWORD`: пароль для доступа к Prometheus
        - Настройки SMTP для отправки email-уведомлений:
            - `SMTP_HOST`, `SMTP_PORT`, `SMTP_USER`, `SMTP_PASSWORD`
            - `SMTP_FROM_EMAIL`, `SMTP_FROM_NAME`
        - `ENCRYPTION_KEY`: ключ шифрования (сгенерируйте случайную строку)
        - `REDIS_PASSWORD`: пароль для Redis
        - `NEXTAUTH_SECRET`: секретный ключ для NextAuth (придумайте сложный)
2. Запуск системы:
    ```bash
    docker-compose up -d
    ```
3. Дождитесь завершения процесса установки и запуска.
4. Перейдите по адресу `http://localhost` в браузере или по IP адресу сервера, чтобы проверить работоспособность системы.

### Сборка Docker-образов по тегам (CI/CD)

Сборка и публикация Docker-образов запускается только при пуше специальных git-тегов. Обычные коммиты в ветки (например, `feature/*`) CI не запускают.

- Формат тега: `<service>-v<semver>`
- Допустимые значения `<service>`:
    - `hw-monitor` — основной сервис Next.js
    - `hw-monitor-licd` — сервис лицензирования LICD
    - `hw-monitor-nginx-combined` — объединённый Nginx (proxy + storage)
- Семантика версий:
    - `X.Y.Z-alpha` — альфа-стрим (предрелизные сборки)
    - `X.Y.Z` — стабильный релиз

Что делает CI при пуше тега:

- Собирает и публикует образ только указанного сервиса
- Публикует два Docker-тега:
    - alias-тег: `alpha` (для `-alpha`) или `latest` (для стабильных версий)
    - версионный тег: `<service>-vX.Y.Z[-alpha[.N]]`
- Для `X.Y.Z-alpha` без числового суффикса CI автоматически добавляет номер сборки `.N` по истории тегов.
  Пример: git-тег `hw-monitor-v1.0.0-alpha` → Docker-теги:
    - `deymonster/hw-monitor:alpha`
    - `deymonster/hw-monitor:hw-monitor-v1.0.0-alpha.3`

Соответствие сервисов и Dockerfile:

- `hw-monitor` → `Dockerfile` (контекст `.`)
- `hw-monitor-licd` → `licd/Dockerfile` (контекст `./licd`)
- `hw-monitor-nginx-combined` → `Dockerfile.nginx-combined` (контекст `.`)

Примеры команд (создание и пуш тегов):

- Next.js (альфа):
    ```bash
    git tag hw-monitor-v1.0.0-alpha
    git push origin hw-monitor-v1.0.0-alpha
    ```
- Next.js (стабильный):
    ```bash
    git tag hw-monitor-v1.0.0
    git push origin hw-monitor-v1.0.0
    ```
- LICD (альфа):
    ```bash
    git tag hw-monitor-licd-v1.0.0-alpha
    git push origin hw-monitor-licd-v1.0.0-alpha
    ```
- Nginx Combined (альфа):
    ```bash
    git tag hw-monitor-nginx-combined-v1.0.0-alpha
    git push origin hw-monitor-nginx-combined-v1.0.0-alpha
    ```

Примечания:

- Теги вида `v1.0.1` (без названия сервиса) не запускают сборку Docker-образов — используйте сервисные теги, как показано выше.
- Если нужен фиксированный номер альфа-сборки, добавьте его прямо в git-тег: `hw-monitor-v1.0.0-alpha.7`.

## Настройка и запуск клиентской части

- Скачайте [агент мониторинга](https://github.com/deymonster/custom_windows_exporter/releases/download/v1.0.10/NITRINOnetControlManagerSetup.exe)
- Установите агент, следуя инструкциям установщика
- После установки агент автоматически запустится и начнет отправлять метрики на сервер
